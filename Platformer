local tiled = require "com.ponywolf.ponytiled"
local physics = require "physics"
local mapData = require "map"

physics.start()
-- physics.setDrawMode("hybrid")

local map = tiled.new(mapData)
map.x = 0
map.y = display.contentCenterY - map.designedHeight/2

man = map:findObject( "man" )
physics.setGravity( 0, -20 )

local points = 0


local scoreText = display.newText(
 "Score: 0",
 display.contentCenterX, 100)


moving_right = false
moving_left = false
is_jumping = false
starty=0

local function onKeyEvent( event )
 
    local message = "Key '" .. event.keyName .. "' was pressed " .. event.phase
    print( message )
 
    if  event.keyName == "right" and event.phase == "down"  then
    	moving_right=true
    	return true
    end

    if  event.keyName == "right" and event.phase == "up"  then
    	moving_right=false
    	return true
    end

    if  event.keyName == "left" and event.phase == "down"  then
    	moving_left=true
    	return true
    end

    if  event.keyName == "left" and event.phase == "up"  then
    	moving_left=false
    	return true
    end


	if  event.keyName == "space" and event.phase == "down"  then
			starty = man.y
	    	man:setLinearVelocity( 0, 200 )
	    	is_jumping = true
    	return true
    end

    return false
end
function onClick( event )

    points=points+1
    scoreText.text = "Score: "..points


end


local function timerListener( event )
    x = math.random(0,display.contentWidth)

    local banknote = display.newImage("banknote.png",x,-100 )
    m = 0.3
    k=math.random()*m+m

    angle = math.random( -45,45 )
    banknote.rotation = angle

    banknote.width=200.0*k
    banknote.height=100.0*k

    banknote:addEventListener( "tap", onClick )

    physics.addBody( banknote, "dynamic" )

end
 
local function onUpdate (event)
	if moving_right then 
		
		if man.x + map.x > display.contentWidth-160 then
			map.x = map.x-3
		end
			man.x = man.x+3	
	end
	if moving_left then

		if man.x+map.x < 10 then
			map.x = map.x+3
		end
		
		man.x = man.x-3	
		
	end
end
timer.performWithDelay( 400, timerListener,-1)
Runtime:addEventListener( "key", onKeyEvent )

Runtime:addEventListener("enterFrame",onUpdate)
